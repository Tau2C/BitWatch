<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="using:BitWatch.ViewModels"
        xmlns:behaviors="using:BitWatch.Behaviors"
        mc:Ignorable="d" d:DesignWidth="1024" d:DesignHeight="768"
        x:Class="BitWatch.MainWindow"
        Title="BitWatch"
        x:DataType="vm:MainWindowViewModel">

  <Design.DataContext>
    <vm:MainWindowViewModel/>
  </Design.DataContext>

  <DockPanel>
    <Menu DockPanel.Dock="Top">
      <MenuItem Header="_File">
        <MenuItem Header="_Settings" Click="OnSettingsMenuItemClick"/>
        <MenuItem Header="_Add Directory" Click="OnAddDirectoryMenuItemClick"/>
        <Separator/>
        <MenuItem Header="_Exit"/>
      </MenuItem>
      <MenuItem Header="_Actions">
        <MenuItem Header="_Calculate Hash" Command="{Binding CalculateHashCommand}" />
        <MenuItem Header="_Run Now" Command="{Binding RunNowCommand}"/>
        <MenuItem Header="_Verify All" Command="{Binding VerifyAllCommand}"/>
      </MenuItem>
      <MenuItem Header="_View">
        <MenuItem Header="_Clear Log" Command="{Binding ClearLogCommand}"/>
      </MenuItem>
    </Menu>

    <Border DockPanel.Dock="Bottom" BorderBrush="Gray" BorderThickness="0,1,0,0">
        <Grid ColumnDefinitions="*,Auto">
            <TextBlock Grid.Column="0" Text="{Binding StatusText}" Margin="5,2"/>
            <ProgressBar Grid.Column="1" Width="200" Margin="5,0"
                         IsIndeterminate="True" 
                         IsVisible="{Binding IsProgressVisible}"/>
        </Grid>
    </Border>

    <Grid ColumnDefinitions="3*,7*">
      <TreeView Grid.Column="0" Margin="5" Name="DirectoryTree" ItemsSource="{Binding Directories}"
                SelectedItem="{Binding SelectedNode}">
        <TreeView.Styles>
          <Style Selector="TreeViewItem">
            <Setter Property="HorizontalAlignment" Value="Stretch"/>
          </Style>
          <Style Selector="TreeViewItem /template/ ContentPresenter#PART_HeaderPresenter">
            <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
          </Style>
        </TreeView.Styles>
        <TreeView.ContextMenu>
          <ContextMenu>
            <MenuItem Header="Add New Directory" Click="OnAddDirectoryMenuItemClick"/>
          </ContextMenu>
        </TreeView.ContextMenu>
        <TreeView.DataTemplates>
          <TreeDataTemplate DataType="vm:DirectoryNodeViewModel" ItemsSource="{Binding Children}">
            <Panel Background="Transparent" HorizontalAlignment="Stretch">
              <Panel.ContextMenu>
                <ContextMenu>
                  <MenuItem Header="Verify" Command="{Binding $parent[TreeView].DataContext.VerifyNodeCommand}" CommandParameter="{Binding}"/>
                  <MenuItem Header="Update Hash" Command="{Binding $parent[TreeView].DataContext.CalculateHashCommand}" CommandParameter="{Binding}"/>
                  <MenuItem Header="Exclude" Command="{Binding $parent[TreeView].DataContext.ExcludeNodeCommand}" CommandParameter="{Binding}" IsVisible="{Binding IsNotExcluded}"/>
                  <MenuItem Header="Remove from excluded" Command="{Binding $parent[TreeView].DataContext.ExcludeNodeCommand}" CommandParameter="{Binding}" IsVisible="{Binding IsExcluded}"/>
                  <MenuItem Header="Remove" Command="{Binding $parent[TreeView].DataContext.RemoveNodeCommand}" CommandParameter="{Binding}" IsVisible="{Binding IsRoot}"/>
                  <Separator IsVisible="{Binding IsRoot}"/>
                  <MenuItem Header="Add New Directory" Click="OnAddDirectoryMenuItemClick"/>
                </ContextMenu>
              </Panel.ContextMenu>
              <Panel>
                <TextBlock Text="{Binding Name}" IsVisible="{Binding IsDefaultColor}"/>
                <TextBlock Text="{Binding Name}" Foreground="{Binding DisplayColor}" IsVisible="{Binding !IsDefaultColor}"/>
              </Panel>
            </Panel>
          </TreeDataTemplate>
          <TreeDataTemplate DataType="vm:FileNodeViewModel">
            <Grid Background="Transparent" ColumnDefinitions="Auto,*" HorizontalAlignment="Stretch">
              <Grid.ContextMenu>
                <ContextMenu>
                  <MenuItem Header="Verify" Command="{Binding $parent[TreeView].DataContext.VerifyNodeCommand}" CommandParameter="{Binding}"/>
                  <MenuItem Header="Update Hash" Command="{Binding $parent[TreeView].DataContext.CalculateHashCommand}" CommandParameter="{Binding}"/>
                  <MenuItem Header="Exclude" Command="{Binding $parent[TreeView].DataContext.ExcludeNodeCommand}" CommandParameter="{Binding}" IsVisible="{Binding IsNotExcluded}"/>
                  <MenuItem Header="Remove from excluded" Command="{Binding $parent[TreeView].DataContext.ExcludeNodeCommand}" CommandParameter="{Binding}" IsVisible="{Binding IsExcluded}"/>
                  <Separator/>
                  <MenuItem Header="Add New Directory" Click="OnAddDirectoryMenuItemClick"/>
                </ContextMenu>
              </Grid.ContextMenu>
              <StackPanel Orientation="Horizontal" Grid.Column="0">
                <TextBlock Text="{Binding Name}" IsVisible="{Binding IsDefaultColor}" />
                <TextBlock Text="{Binding Name}" Foreground="{Binding DisplayColor}" IsVisible="{Binding !IsDefaultColor}" />
              </StackPanel>
            </Grid>
          </TreeDataTemplate>
        </TreeView.DataTemplates>
      </TreeView>
      
      <GridSplitter Grid.Column="0" Width="2" HorizontalAlignment="Right" VerticalAlignment="Stretch" Background="Gray"/>

      <ListBox Grid.Column="1" Margin="5" Name="LogPanel" ItemsSource="{Binding LogMessages}"
               behaviors:ListBoxBehaviors.AutoScroll="True">
        <!-- Log messages will be displayed here -->
      </ListBox>
    </Grid>
  </DockPanel>

</Window>
